---
title: "Data cleaning step"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

In this page, the data cleaning process is described.

# Data source and the data cleaning goal

- __Data source__
  
  - __Popular music data__: [Data on Songs from Billboard 1999-2019](https://www.kaggle.com/danield2255/data-on-songs-from-billboard-19992019) collected the data of Billboard Hot 100 music chart from July 11, 1999 to July 5, 2019. The data set contains current weeks the song has been on the chart, music genre, peak rank, and full explicit lyrics.

  - __Illicit drug usage data__: The NSDUH series, formerly the National Household Survey on Drug Abuse, is the leading source of statistical information on the use of illicit drugs, alcohol, and tobacco and mental health issues in the United States. The population of the NSDUH series is the general civilian population aged 12 and older. Questions include age at first use, as well as lifetime, annual, and past-month use of alcohol, marijuana, and other substances, as well as the perceptions on the substances. In this project, we used [National Survey on Drug Use and Health (NSDUH) 1999-2019](https://www.datafiles.samhsa.gov/dataset/national-survey-drug-use-and-health-2019-nsduh-2019-ds0001) to analyse the substance use.  The data set is has both state-level and national-level small area estimates (SAEs) and associated confidence intervals.

  - __Substance word list__: We included 2 word lists from an addiction center [website](https://www.addictioncenter.com/). They are [Drug Street Names](https://www.addictioncenter.com/drugs/drug-street-names/) and [Drug And Alcohol Slang Terms](https://www.addictioncenter.com/drugs/drug-alcohol-slang/).

- The final data for analysis should be:
  - A data set combining both substance use information and portrayals of substance use in songs, by year
  - A data set describing the frequency and annual rate (with 95% confidence interval) of songs in different genre (hip-hop/R&B, rap, rock, and country) and songs mentioning substances (alcohol, marijuana, other illicit drugs), by year.

# Cleaning process

- Lyrics
  - Music data
    - Download the Billboard data from the website using `Kaggler`. It's a zip file, so unzip the file and put the data into the data folder. The Billboard data is named as 'billboard'.*The unzip code is put into annotation because of error when knitting. For reproducing the result, please run the code after remove the "#."*
    - Keep the needed variables, and set all the strings lower case
    - Keep the year data
    - Because we are going to see the effect of the genre/lyrics instead of the real number of the songs, we did not delete duplicate songs and the data
    - To make manual data check easier, keep the name of the songs
    - This data set is larger than 100Mb, so it's not pushed to the repository.
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE )

library(tidyverse)
library(rvest)
library(httr)
library(kaggler)
library(haven)

kgl_auth(creds_file = 'kaggle.json')

response <- kgl_datasets_download_all(owner_dataset = "danield2255/data-on-songs-from-billboard-19992019")

download.file(response[["url"]], "./data/temp.zip", mode = "wb")
#unzip_result <- unzip("./data/temp.zip", exdir = "./data", overwrite = TRUE)

billboard = read_csv("./data/BillboardFromLast20/billboardHot100_1999-2019.csv") %>%
  janitor::clean_names() %>%
  select(week,name,genre,lyrics) %>%
  mutate(year = substr(week,1,4),
         lyrics = str_to_lower(str_replace(lyrics, "\n"," ")),
         genre = str_to_lower(genre)) %>%
  relocate(year, name, genre) %>%
  select(-week)

knitr::kable(billboard[1:5, ])
```


  - Music genre word list
    - The music genre word list is generated from the genre variable from the billboard data. Since there are over 300 genres in the original data set, we manually reclassified these genres into 4 categories: hip-hop/R&B, country, rap, and rock. This classification is adapted from [Primak et al.](https://pubmed.ncbi.nlm.nih.gov/18250243/).
    
```{r genre list}
word_bank_genre_raw = pull(billboard, genre) %>%
  unlist() %>%
  unique() %>%
  as_tibble()

write.csv(word_bank_genre_raw, file = "./data/word_bank_genre_raw_ling.csv")

genre = read_csv(file = "./data/genre.csv",
                         col_names = TRUE,
                         na = "") %>%
  select(-...1) %>%
  group_by(genre_cate) %>%
  summarise(subgenre = paste(value, collapse = "|")) %>%
  drop_na(genre_cate)

country = pull(subset(genre, genre_cate == "country"), subgenre)
hiphop = pull(subset(genre, genre_cate == "hip-hop/r&;b"), subgenre)
rap = pull(subset(genre, genre_cate == "rap"), subgenre)
rock = pull(subset(genre, genre_cate == "rock"), subgenre)
```

  - Substance word list
    - Download the word lists from the website using `rvest` and `httr`, the 2 lists are named as `word_bank_raw` and `word_bank_raw2`, respectively.
    - Manually delete the too general terms (i.e., "black" refers to cocaine in some contexts)
    - For each sublists, combine the strings together, separated by " | ".
    - Combine the sublists describing the same (group of) substance together. Since the data for the substances other than alcohol and marijuana are limited, we combined the words describing the substances other than alcohol or marijuana together, taking [Primak et al.](https://pubmed.ncbi.nlm.nih.gov/18250243/) as a reference.
  

```{r substance list}
word_bank_raw = read_html("https://www.addictioncenter.com/drugs/drug-street-names/") %>%
  html_table(header = T)

word_bank_raw2 =  read_html("https://www.addictioncenter.com/drugs/drug-alcohol-slang/") %>%
  html_table(header = F) %>%
  .[-c(1,2,3)] %>%
  bind_rows() %>%
  select(X2) %>%
  mutate(slang = str_split(str_to_lower(X2), ',')) %>%
  select(slang) %>%
  unlist() %>%
  as_tibble()

word_bank_alcohol = read_html("https://www.addictioncenter.com/drugs/drug-alcohol-slang/") %>%
  html_table(header = F) %>%
  nth(2) %>%
  janitor::clean_names() %>%
  select(x2) %>%
  mutate(x2 = str_split(str_to_lower(x2), ',')) %>%
  unlist() %>%
  as_tibble()

write.csv(word_bank_alcohol, file = "./data/alcohol_bank_raw_ling.csv")

drug_bank <- function(raw , var) {
  out = raw %>%
  janitor::clean_names() %>%
  select({{var}}) %>%
  mutate(slang = str_split(str_to_lower({{var}}), ',')) %>%
  select(slang) %>%
  unlist() %>%
  as_tibble()
  return(out)
}

illicit_names = word_bank_raw[[3]] %>%
  janitor::clean_names()

word_bank_bdz = drug_bank(word_bank_raw[[1]], var = street_names)
word_bank_hallucinogens = drug_bank(word_bank_raw[[2]], var = street_names)
word_bank_inhalant = drug_bank(word_bank_raw[[4]], var = street_names)
word_bank_opioid = drug_bank(word_bank_raw[[5]], var = street_names)
word_bank_overcounter = drug_bank(word_bank_raw[[6]], var = street_names)
word_bank_marijuana = drug_bank(subset(illicit_names, common_name %in% c("Marijuana", "Synthetic Marijuana")), var = other_names)
word_bank_illicit = drug_bank(subset(illicit_names, !(common_name %in% c("Marijuana", "Synthetic Marijuana"))), var = other_names)
word_bank_other = bind_rows(word_bank_bdz, word_bank_hallucinogens, word_bank_illicit, word_bank_inhalant, word_bank_opioid, word_bank_overcounter, word_bank_raw2)
word_bank_marijuana2 = read_html("https://www.addictioncenter.com/drugs/drug-alcohol-slang/") %>%
  html_table(header = F) %>%
  nth(3) %>%
  select(X2) %>%
  mutate(slang = str_split(str_to_lower(X2), ',')) %>%
  unlist() %>%
  as_tibble()
word_bank_marijuana = bind_rows(word_bank_marijuana, word_bank_marijuana2)

write_csv(word_bank_other, file = "./data/other_illicit_bank_raw_ling.csv")
write_csv(word_bank_marijuana, file = "./data/marijuana_bank_raw_ling.csv")

words_alcohol = read_lines("./data/alcohol.csv")
regex_alcohol = paste(words_alcohol,collapse = " | ")

words_marijuana = read_lines("./data/marijuana.csv")
regex_marijuana = paste(words_marijuana,collapse = " | ")

words_other = read_lines("./data/other_illicit.csv")
regex_other = paste(words_other,collapse = " | ")

```
  
  - Summarize the song information by year
    - substance description data ('songs' data)
      - this data is cleaned separately to be combined with the substance abuse data
      - summarize the frequency of songs mentioning substances in each year
      - calculate the 95% confidence interval of the frequencies
      
    - substance description and genre data ('genly_billboard' data)
      - summarize the frequency of song mentioning substances and genre in each year
      - calculate the 95% confidence interval of the frequencies
    
```{r billboard summary}
billboard_data = billboard %>%
   mutate(
    marijuana = as.numeric(grepl(regex_marijuana,lyrics,ignore.case = TRUE)),
    alcohol = as.numeric(grepl(regex_alcohol,lyrics,ignore.case = TRUE)),
    other_illicit = as.numeric(grepl(regex_other,lyrics,ignore.case = TRUE)),
    gen_country = as.numeric(grepl(country, genre, ignore.case = TRUE)),
    gen_hiphop = as.numeric(grepl(hiphop, genre, ignore.case = TRUE)),
    gen_rap = as.numeric(grepl(rap, genre, ignore.case = TRUE)),
    gen_rock = as.numeric(grepl(rock, genre, ignore.case = TRUE))
    ) %>%
    select(-lyrics, -genre) 


write_csv(billboard_data, file = "./data/billboard_cleaned.csv", col_names = TRUE)

songs = billboard_data %>%
    pivot_longer(cols = c("marijuana", "alcohol","other_illicit"),
                 names_to = "lyr_des",
                 values_to = "lyric_yn") %>%
    group_by(year, lyr_des) %>%
    summarise(n_lyrics = sum(lyric_yn == 1),
              total = n()) %>%
    mutate(p_result = map2(.x = n_lyrics, .y = total, ~prop.test(.x, .y, conf.level = 0.95)),
           p_lyrics = 100*(unlist(map(p_result, pluck("estimate")))),
           p_ci = map(p_result, pluck("conf.int"))) %>%
    unnest_wider(p_ci) %>%
    rename("p_lci" = "...1",
           "p_uci" = "...2") %>%
    mutate(p_lci = 100 * p_lci,
           p_uci = 100 * p_uci,
           year = as.numeric(year)) %>%
    select(-p_result)

knitr::kable(songs[1:5, ])

genly_billboard = billboard_data %>%
  pivot_longer(cols = c("marijuana", "alcohol","other_illicit"),
                 names_to = "lyr_des",
                 values_to = "lyric_yn") %>%
  pivot_longer(cols = starts_with("gen_"),
               names_to = "gen_cate",
               values_to = "gen_yn") %>%
  mutate(lyr_gen = as_factor(paste(lyr_des, gen_cate, sep = ",")),
         lyr_gen_yn = if_else(lyric_yn == 1 & gen_yn == 1, 1, 0)) %>%
  group_by(lyr_gen, year, gen_cate) %>%
  summarize(n_lyr = sum(lyric_yn == 1),
            total = n(),
            n_gen = sum(gen_yn == 1),
            n_lyr_gen = sum(lyr_gen_yn == 1)) %>%
  mutate(p_lyr_res = map2(.x = n_lyr, .y = total, ~prop.test(.x, .y, conf.level = 0.95)),
         p_lyrics = 100 * unlist(map(p_lyr_res, pluck("estimate"))),
         p_lyr_ci = map(p_lyr_res, pluck("conf.int")),
         p_lyr_lci = 100 * min(unlist(p_lyr_ci)),
         p_lyr_uci = 100 * max(unlist(p_lyr_ci)),
         p_gen_res = map2(.x = n_gen, .y = total, ~prop.test(.x, .y, conf.level = 0.95)),
         p_genre = 100 * unlist(map(p_gen_res, pluck("estimate"))),
         p_gen_ci = map(p_gen_res, pluck("conf.int")),
         p_gen_lci = 100 * min(unlist(p_gen_ci)),
         p_gen_uci = 100 * max(unlist(p_gen_ci)),
         p_lyrgen_res = map2(.x = n_lyr_gen, .y = n_gen, ~prop.test(.x, .y, conf.level = 0.95)),
         p_lyrgen = 100 * unlist(map(p_lyrgen_res, pluck("estimate"))),
         p_lyrgen_ci = map(p_lyrgen_res, pluck("conf.int")),
         p_lyrgen_lci = 100 * min(unlist(p_lyrgen_ci)),
         p_lyrgen_uci = 100 * max(unlist(p_lyrgen_ci)),
         lyr_des = str_split(lyr_gen, ","),
         lyr_des = first(unlist(lyr_des)),
         year = as.numeric(year),
         gen_cate = str_replace(gen_cate, "hip-hop","hip-hop/RnB")) %>%
  select(-p_lyr_res, -p_lyr_ci, -p_gen_res, -p_gen_ci, -p_lyrgen_res,-p_lyrgen_ci) %>%
  arrange(year) %>%
  relocate(year, lyr_des, gen_cate, lyr_gen, n_lyr, n_gen, n_lyr_gen)

write_csv(genly_billboard, file = "./data/genly_billboard.csv", col_names = TRUE)

knitr::kable(genly_billboard[1:5, ])
```
    
- NSDUH data
  - download the data and load the SAS file
  - clean the names
  - keep the variables needed
  - restrict the outcomes of interest, restrict the age groups (12-18 years old, 18-25 years old, 26 years and older)
  - clean the values, and change the proportions into percentage
  - take the beginning year of each survey as the year as identifier

```{r}
download.file(url = "https://www.datafiles.samhsa.gov/sites/default/files/NSDUH_files/SAE/NSDUH_99_19_state_saes_final.sas7bdat", 
                      destfile = "./data/abuse.sas7bdat", mode = "wb")
abuse_df = read_sas(data_file = "./data/abuse.sas7bdat")
abuse = abuse_df %>%
  janitor::clean_names() %>%
  select(pyear,agegrp,outcome,area,bsae, low_sae, up_sae, stname, state, pyearnm) %>%
  filter(outcome %in% c("COCYR", "IEMMON","MRJMON","SUMMON","INCIDENCE","BNGALC","RISKMJ") & pyear != "11" & agegrp %in% c(1,2,3)) %>%
  mutate(outcome = fct_recode(as_factor(outcome), "Cocaine use in the last year" = "COCYR",
                                                  "Illicit drugs other than marijuana use in the last month" = "IEMMON",
                                                  "Marijuana use in the past month" = "MRJMON",
                                                  "Any illicit drug use in the last month" = "SUMMON",
                                                  "Annual incidence of first use of marijuana" = "INCIDENCE",
                                                  "Binge drinking in the last month" = "BNGALC",
                                                  "Risk perception on smoking marijuana once a month" = "RISKMJ"),
         pyearnm = substr(pyearnm, 1,9),
         pyearnm = fct_reorder(as.factor(pyearnm), pyear),
         agegrp = fct_recode(as_factor(agegrp), "12-17 y/o" = "1",
                                                "18-25 y/o" = "2",
                                                ">=26 y/o" = "3"),
         area = as.factor(area),
         stname = as.factor(stname),
         bsae = 100 * bsae,
         low_sae = 100 * low_sae,
         up_sae = 100 * up_sae,
         year = as.numeric(substr(pyearnm,1,4))) %>%
  select(-pyear, -state)

knitr::kable(abuse[1:5, ])
```

- Combine the songs data and the abuse data
```{r}
# individual song data

# connnect the songs and the abuse data
songs_abuse = left_join(songs, abuse, by = "year")

write_csv(songs_abuse, file = "./data/songs_abuse.csv", col_names = TRUE)

knitr::kable(songs_abuse[1:5, ])
```

- Now the whole data cleaning process is completed
  - The songs_abuse data include the substance description frequency and substance abuse information in each year, from 1999 to 2019
  - The genly_billboard data include the genre frequency in each year and the substance description frequency in each genre each year, from 1999 to 2019


